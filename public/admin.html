<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - برنامج الطاقة الشمسية</title>
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --success-color: #2e7d32;
            --danger-color: #d32f2f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 20px;
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--background-color);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            outline: none;
            direction: ltr;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .login-form button:hover {
            background: var(--primary-dark);
        }

        /* Admin Container (Hidden by default) */
        #admin-container {
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* ... rest of styles ... */
        .header {
            background: var(--primary-color);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
        }

        /* ... existing styles ... */
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .tabs {
            display: flex;
            background: #eee;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: white;
        }

        .content-area {
            padding: 25px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* ... rest of existing CSS ... */


        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .section-title {
            color: var(--primary-dark);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-light);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card-item {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 6px;
            position: relative;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .toolbar {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: left;
        }

        .array-container {
            margin-top: 10px;
        }

        .array-item {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-msg {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            display: none;
            animation: slideUp 0.3s;
        }

        .status-success {
            background: var(--success-color);
        }

        .status-error {
            background: var(--danger-color);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* User Management Styles */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .user-table th {
            background: #f4f4f4;
            color: #333;
        }

        .user-table tr:hover {
            background: #fcfcfc;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-inactive {
            background: #ffebee;
            color: #c62828;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>تسجيل الدخول</h2>
            <div class="login-form">
                <input type="text" id="username" placeholder="اسم المستخدم" style="direction: ltr;">
                <input type="password" id="password" placeholder="كلمة المرور" style="direction: ltr;">
                <button type="button" onclick="checkLogin()">دخول</button>
            </div>
            <p id="login-error" style="color: red; margin-top: 10px; display: none;">بيانات الدخول غير صحيحة</p>
        </div>
    </div>

    <div id="admin-container">
        <div class="container">
            <div class="header">
                <h1>لوحة التحكم - إعدادات النظام</h1>
                <a href="/" class="back-btn">رجوع للتطبيق</a>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('general')">معلومات عامة</button>
                <button class="tab-btn" onclick="showTab('devices')">استهلاك الأجهزة</button>
                <button class="tab-btn" onclick="showTab('solar')">الألواح والأنفرترات</button>
                <button class="tab-btn" onclick="showTab('batteries')">البطاريات</button>
                <button class="tab-btn" onclick="showTab('theme')">الألوان والمظهر</button>
                <button class="tab-btn" onclick="showTab('print')">إعدادات الطباعة</button>
                <button class="tab-btn" onclick="showTab('users')">إدارة المستخدمين</button>
            </div>

            <div class="content-area">
                <form id="settings-form">

                    <!-- General Tab -->
                    <div id="general" class="tab-content active">
                        <h3 class="section-title">بيانات المؤسسة</h3>
                        <div class="form-group">
                            <label>عنوان التطبيق (العريض)</label>
                            <input type="text" class="form-control" name="companyInfo.title">
                        </div>
                        <div class="form-group">
                            <label>العنوان الفرعي</label>
                            <input type="text" class="form-control" name="companyInfo.subtitle">
                        </div>
                        <div class="form-group">
                            <label>نص الهيدر (جهة اليسار)</label>
                            <input type="text" class="form-control" name="companyInfo.headerContact">
                        </div>
                        <div class="form-group">
                            <label>رقم الواتساب للاستقبال</label>
                            <input type="text" class="form-control" name="companyInfo.whatsappNumber">
                        </div>

                        <h3 class="section-title" style="margin-top: 20px;">بيانات دخول المسؤول</h3>
                        <div class="form-group">
                            <label>اسم المستخدم</label>
                            <input type="text" class="form-control" name="authConfig.username">
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="text" class="form-control" name="authConfig.password">
                        </div>
                    </div>

                    <!-- Devices Tab -->
                    <div id="devices" class="tab-content">
                        <h3 class="section-title">استهلاك الأجهزة (واط)</h3>
                        <div class="card-grid">
                            <div class="form-group">
                                <label>لمبات</label>
                                <input type="number" class="form-control" name="deviceConsumption.lamps">
                            </div>
                            <div class="form-group">
                                <label>مراوح</label>
                                <input type="number" class="form-control" name="deviceConsumption.fans">
                            </div>
                            <div class="form-group">
                                <label>شاشة تلفزيون</label>
                                <input type="number" class="form-control" name="deviceConsumption.tv">
                            </div>
                            <div class="form-group">
                                <label>ثلاجة</label>
                                <input type="number" class="form-control" name="deviceConsumption.fridge">
                            </div>
                            <div class="form-group">
                                <label>غسالة</label>
                                <input type="number" class="form-control" name="deviceConsumption.washing_machine">
                            </div>
                            <div class="form-group">
                                <label>مكيف طن (نهار)</label>
                                <input type="number" class="form-control" name="deviceConsumption.ac1_day">
                            </div>
                            <div class="form-group">
                                <label>مكيف طن (ليل)</label>
                                <input type="number" class="form-control" name="deviceConsumption.ac1_night">
                            </div>
                            <div class="form-group">
                                <label>مكيف طن ونص (نهار)</label>
                                <input type="number" class="form-control" name="deviceConsumption.ac1_5_day">
                            </div>
                            <div class="form-group">
                                <label>مكيف طن ونص (ليل)</label>
                                <input type="number" class="form-control" name="deviceConsumption.ac1_5_night">
                            </div>
                        </div>
                    </div>

                    <!-- Solar & Inverter Tab -->
                    <div id="solar" class="tab-content">
                        <h3 class="section-title">ثوابت الطاقة الشمسية</h3>
                        <div class="card-grid">
                            <div class="form-group">
                                <label>ساعات الذروة (Peak Hours)</label>
                                <input type="number" step="0.1" class="form-control" name="solarCalculation.peakHours">
                            </div>
                            <div class="form-group">
                                <label>هامش الأمان (Safety Margin)</label>
                                <input type="number" step="0.1" class="form-control"
                                    name="solarCalculation.safetyMargin">
                            </div>
                        </div>

                        <h3 class="section-title" style="margin-top: 20px;">أسماء الألواح (للعرض والطباعة)</h3>
                        <div class="card-grid">
                            <div class="form-group">
                                <label>اسم لوح 585</label>
                                <input type="text" class="form-control" name="panel_names.panel_585"
                                    placeholder="مثال: لوح 585 واط">
                            </div>
                            <div class="form-group">
                                <label>اسم لوح 645</label>
                                <input type="text" class="form-control" name="panel_names.panel_645"
                                    placeholder="مثال: لوح 645 واط">
                            </div>
                            <div class="form-group">
                                <label>اسم لوح 715</label>
                                <input type="text" class="form-control" name="panel_names.panel_715"
                                    placeholder="مثال: لوح 715 واط">
                            </div>
                        </div>

                        <h3 class="section-title">قواعد الأنفرتر (حسب عدد الألواح)</h3>
                        <div id="inverter-rules-container" class="array-container"></div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addInverterRule()">+ إضافة قاعدة
                            أنفرتر</button>

                        <h3 class="section-title" style="margin-top: 20px;">قواعد الأنفرتر (دايا - حسب الحمل)</h3>
                        <div id="inverter-load-rules-container" class="array-container"></div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addInverterLoadRule()">+ إضافة
                            قاعدة
                            دايا</button>
                    </div>

                    <!-- Batteries Tab -->
                    <div id="batteries" class="tab-content">
                        <h3 class="section-title">قائمة البطاريات (حسب استهلاك الليل)</h3>
                        <div id="battery-rules-container" class="array-container"></div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addBatteryRule()">+ إضافة
                            بطارية</button>
                    </div>

                    <!-- Theme Tab -->
                    <div id="theme" class="tab-content">
                        <h3 class="section-title">إعدادات الألوان والمظهر</h3>
                        <div class="card-grid">
                            <div class="form-group">
                                <label>اللون الرئيسي (Primary)</label>
                                <input type="color" class="form-control" name="themeColors.primary"
                                    style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>اللون الرئيسي الفاتح (Primary Light)</label>
                                <input type="color" class="form-control" name="themeColors.primaryLight"
                                    style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>اللون الرئيسي الداكن (Primary Dark)</label>
                                <input type="color" class="form-control" name="themeColors.primaryDark"
                                    style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>لون الخلفية (Background)</label>
                                <input type="color" class="form-control" name="themeColors.background"
                                    style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>لون الكروت (Card)</label>
                                <input type="color" class="form-control" name="themeColors.card" style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>لون النص (Text)</label>
                                <input type="color" class="form-control" name="themeColors.text" style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>لون الحدود (Border)</label>
                                <input type="color" class="form-control" name="themeColors.border"
                                    style="height: 50px;">
                            </div>
                        </div>
                    </div>

                    <!-- Print Tab -->
                    <div id="print" class="tab-content">
                        <h3 class="section-title">إعدادات الطباعة</h3>
                        <div class="card-grid">
                            <div class="form-group">
                                <label>عنوان التقرير (Header Title)</label>
                                <input type="text" class="form-control" name="printConfig.headerTitle">
                            </div>
                            <div class="form-group">
                                <label>العنوان الفرعي (Header Subtitle)</label>
                                <input type="text" class="form-control" name="printConfig.headerSubtitle">
                            </div>
                            <div class="form-group">
                                <label>نص التذييل (Footer Text)</label>
                                <input type="text" class="form-control" name="printConfig.footerText">
                            </div>
                            <div class="form-group">
                                <label>معلومات الاتصال (Contact Info)</label>
                                <input type="text" class="form-control" name="printConfig.contactInfo">
                            </div>
                            <div class="form-group">
                                <label>لون الطباعة الرئيسي (Print Primary)</label>
                                <input type="color" class="form-control" name="printConfig.primaryColor"
                                    style="height: 50px;">
                            </div>
                            <div class="form-group">
                                <label>لون نص الطباعة (Print Text)</label>
                                <input type="color" class="form-control" name="printConfig.textColor"
                                    style="height: 50px;">
                            </div>
                        </div>
                    </div>

                    <div class="toolbar">
                        <button type="button" class="btn btn-success" onclick="saveSettings()">حفظ التعديلات</button>
                        <button type="button" class="btn" style="background-color: #d32f2f; color: white;"
                            onclick="resetDefaults()">استعادة الافتراضي</button>

                        <div
                            style="display: inline-block; margin-right: 20px; border-right: 2px solid #ddd; padding-right: 20px;">
                            <button type="button" class="btn" style="background-color: #1976d2; color: white;"
                                onclick="exportDatabase()">تصدير قاعدة البيانات</button>
                            <button type="button" class="btn" style="background-color: #f57c00; color: white;"
                                onclick="document.getElementById('import-file').click()">استيراد قاعدة البيانات</button>
                            <input type="file" id="import-file" style="display: none;" accept=".json"
                                onchange="importDatabase(this)">
                        </div>
                    </div>
                    <!-- User Management Tab -->
                    <div id="users" class="tab-content">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title" style="margin: 0;">إدارة المستخدمين</h3>
                            <button type="button" class="btn btn-success" onclick="openUserModal()">+ إضافة
                                مستخدم</button>
                        </div>

                        <div class="user-list-container">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>اسم المستخدم</th>
                                        <th>كلمة المرور</th>
                                        <th>الطباعة</th>
                                        <th>الحالة</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body">
                                    <!-- Users populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- User Modal (Add/Edit) -->
                    <div id="user-modal" class="modal-overlay" style="display: none;">
                        <div class="modal-card">
                            <h3 id="modal-title">إضافة مستخدم جديد</h3>
                            <input type="hidden" id="user-id">
                            <div class="form-group">
                                <label>الاسم الظاهر</label>
                                <input type="text" id="user-display-name" class="form-control" placeholder="اسم الحساب">
                            </div>
                            <div class="form-group">
                                <label>اسم المستخدم (للدخول)</label>
                                <input type="text" id="user-username" class="form-control" style="direction: ltr;">
                            </div>
                            <div class="form-group">
                                <label>كلمة المرور</label>
                                <input type="text" id="user-password" class="form-control" style="direction: ltr;">
                            </div>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="user-can-print" checked> صلاحية الطباعة
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="user-is-active" checked> حساب مفعل
                                </label>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn btn-primary" onclick="saveUser()"
                                    style="flex: 1;">حفظ</button>
                                <button type="button" class="btn btn-danger" onclick="closeUserModal()"
                                    style="flex: 1;">إلغاء</button>
                            </div>
                        </div>
                    </div>

                </form>
            </div>


        </div>

        <div id="status-msg" class="status-msg"></div>

        <script>
            let settings = {};

            // Load Settings
            async function loadSettings() {
                try {
                    // Check Permissions first
                    const statusRes = await fetch('/system-status');
                    if (statusRes.ok) {
                        const status = await statusRes.json();
                        if (status && status.adminTabs) {
                            // Hide buttons
                            const tabBtns = document.querySelectorAll('.tab-btn');
                            let firstVisibleTab = null;
                            tabBtns.forEach(btn => {
                                const tabName = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                                if (status.adminTabs[tabName] === false) {
                                    btn.style.display = 'none';
                                } else if (!firstVisibleTab) {
                                    firstVisibleTab = tabName;
                                }
                            });

                            // If current active tab is hidden, switch to first visible
                            const activeBtn = document.querySelector('.tab-btn.active');
                            if (activeBtn && activeBtn.style.display === 'none' && firstVisibleTab) {
                                showTab(firstVisibleTab);
                            }
                        }
                    }

                    const res = await fetch('/get-settings');
                    settings = await res.json();
                    populateForm(settings);
                } catch (e) {
                    console.error("Failed to load settings", e);
                    showStatus("فشل تحميل الاعدادات", "error");
                }
            }

            // --- Layout Helpers ---
            function showTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

                const content = document.getElementById(tabId);
                if (content) content.classList.add('active');

                // Find the button that calls this tab and activate it
                const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick') && b.getAttribute('onclick').includes(`'${tabId}'`));
                if (btn) btn.classList.add('active');
            }

            function showStatus(msg, type) {
                const el = document.getElementById('status-msg');
                el.textContent = msg;
                el.className = 'status-msg status-' + type;
                el.style.display = 'block';
                setTimeout(() => { el.style.display = 'none'; }, 3000);
            }

            // --- Data Binding ---
            // Function to populate the entire form
            function populateForm(data) {
                // Flatten basic fields
                const inputs = document.querySelectorAll('input[name^="companyInfo"], input[name^="authConfig"], input[name^="emailConfig"], input[name^="deviceConsumption"], input[name^="solarCalculation"], input[name^="themeColors"], input[name^="printConfig"], input[name^="prices"], input[name^="panel_names"]');
                inputs.forEach(input => {
                    const parts = input.name.split('.');
                    if (data[parts[0]] && data[parts[0]][parts[1]] !== undefined) {
                        input.value = data[parts[0]][parts[1]];
                    }
                });

                // Complex Arrays (New Mapping with snake_case support)
                renderInverterRules(data.inverters || []);
                renderInverterLoadRules(data.inverters_load_rules || data.invertersLoadRules || []);
                renderBatteryRules(data.batteries || []);
            }

            // --- Renderers ---
            function renderInverterRules(rules) {
                const container = document.getElementById('inverter-rules-container');
                container.innerHTML = '';
                rules.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'array-item';
                    div.innerHTML = `
                    <button type="button" class="remove-btn" onclick="removeInverterRule(${index})">×</button>
                    <h4>أنفرتر ${index + 1}</h4>
                    <div class="card-grid">
                        <div class="form-group"><label>ID (مميز)</label><input type="text" class="form-control" value="${rule.id || ''}" onchange="updateInverterRule(${index}, 'id', this.value)"></div>
                        <div class="form-group"><label>الاسم</label><input type="text" class="form-control" value="${rule.name || ''}" onchange="updateInverterRule(${index}, 'name', this.value)"></div>
                        <div class="form-group"><label>السعر ($)</label><input type="number" class="form-control" value="${rule.price || 0}" onchange="updateInverterRule(${index}, 'price', this.value)"></div>
                        
                        <div class="form-group"><label>Max 585 Panel</label><input type="number" class="form-control" value="${rule.max_panels_585 || rule.maxPanels585 || 0}" onchange="updateInverterRule(${index}, 'max_panels_585', this.value)"></div>
                        <div class="form-group"><label>Max 645 Panel</label><input type="number" class="form-control" value="${rule.max_panels_645 || rule.maxPanels645 || 0}" onchange="updateInverterRule(${index}, 'max_panels_645', this.value)"></div>
                        <div class="form-group"><label>Max 715 Panel</label><input type="number" class="form-control" value="${rule.max_panels_715 || rule.maxPanels715 || 0}" onchange="updateInverterRule(${index}, 'max_panels_715', this.value)"></div>
                        <div class="form-group"><label>Max Night Cons.</label><input type="number" class="form-control" value="${rule.max_night_consumption || rule.maxNightConsumption || 0}" onchange="updateInverterRule(${index}, 'max_night_consumption', this.value)"></div>
                        
                        <div class="form-group" style="grid-column: span 3;"><label>التفاصيل</label><input type="text" class="form-control" value="${rule.details || ''}" onchange="updateInverterRule(${index}, 'details', this.value)"></div>
                    </div>
                `;
                    container.appendChild(div);
                });
            }

            function renderInverterLoadRules(rules) {
                const container = document.getElementById('inverter-load-rules-container');
                container.innerHTML = '';
                rules.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'array-item';
                    div.innerHTML = `
                    <button type="button" class="remove-btn" onclick="removeInverterLoadRule(${index})">×</button>
                    <h4>أنفرتر دايا ${index + 1}</h4>
                    <div class="card-grid">
                        <div class="form-group"><label>ID</label><input type="text" class="form-control" value="${rule.id || ''}" onchange="updateInverterLoadRule(${index}, 'id', this.value)"></div>
                        <div class="form-group"><label>الاسم</label><input type="text" class="form-control" value="${rule.name || ''}" onchange="updateInverterLoadRule(${index}, 'name', this.value)"></div>
                        <div class="form-group"><label>السعر ($)</label><input type="number" class="form-control" value="${rule.price || 0}" onchange="updateInverterLoadRule(${index}, 'price', this.value)"></div>
                        <div class="form-group"><label>Max Load (Watt)</label><input type="number" class="form-control" value="${rule.max_hourly_load || rule.maxHourlyLoad || 0}" onchange="updateInverterLoadRule(${index}, 'max_hourly_load', this.value)"></div>
                        <div class="form-group"><label>Max 585 Panel</label><input type="number" class="form-control" value="${rule.max_panels_585 || rule.maxPanels585 || 0}" onchange="updateInverterLoadRule(${index}, 'max_panels_585', this.value)"></div>
                         <div class="form-group"><label>Max Night Cons.</label><input type="number" class="form-control" value="${rule.max_night_consumption || rule.maxNightConsumption || 0}" onchange="updateInverterLoadRule(${index}, 'max_night_consumption', this.value)"></div>
                         
                        <div class="form-group" style="grid-column: span 3;"><label>التفاصيل</label><input type="text" class="form-control" value="${rule.details || ''}" onchange="updateInverterLoadRule(${index}, 'details', this.value)"></div>
                    </div>
                `;
                    container.appendChild(div);
                });
            }

            function renderBatteryRules(rules) {
                const container = document.getElementById('battery-rules-container');
                container.innerHTML = '';
                rules.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'array-item';
                    div.innerHTML = `
                    <button type="button" class="remove-btn" onclick="removeBatteryRule(${index})">×</button>
                    <h4>بطارية ${index + 1}</h4>
                    <div class="card-grid">
                        <div class="form-group"><label>ID</label><input type="text" class="form-control" value="${rule.id || ''}" onchange="updateBatteryRule(${index}, 'id', this.value)"></div>
                        <div class="form-group"><label>الاسم</label><input type="text" class="form-control" value="${rule.name || ''}" onchange="updateBatteryRule(${index}, 'name', this.value)"></div>
                        <div class="form-group"><label>السعر ($)</label><input type="number" class="form-control" value="${rule.price || 0}" onchange="updateBatteryRule(${index}, 'price', this.value)"></div>
                        
                        <div class="form-group"><label>Min Night Cons.</label><input type="number" class="form-control" value="${rule.min_consumption || rule.minConsumption || 0}" onchange="updateBatteryRule(${index}, 'min_consumption', this.value)"></div>
                        <div class="form-group"><label>Max Night Cons.</label><input type="number" class="form-control" value="${rule.max_consumption || rule.maxConsumption || 0}" onchange="updateBatteryRule(${index}, 'max_consumption', this.value)"></div>
                        
                        <div class="form-group"><label>السعة (للعرض)</label><input type="text" class="form-control" value="${rule.capacity || ''}" onchange="updateBatteryRule(${index}, 'capacity', this.value)"></div>
                        <div class="form-group"><label>الصافي (watt)</label><input type="text" class="form-control" value="${rule.net || ''}" onchange="updateBatteryRule(${index}, 'net', this.value)"></div>
                        <div class="form-group"><label>العدد</label><input type="number" class="form-control" value="${rule.count_modifier || rule.countModifier || 1}" onchange="updateBatteryRule(${index}, 'count_modifier', this.value)"></div>
                        <div class="form-group" style="grid-column: span 3;"><label>التفاصيل</label><input type="text" class="form-control" value="${rule.details || ''}" onchange="updateBatteryRule(${index}, 'details', this.value)"></div>
                    </div>
                `;
                    container.appendChild(div);
                });
            }

            // --- Logic Handlers ---
            function updateInverterRule(index, field, value) { settings.inverters[index][field] = value; }
            function removeInverterRule(index) { settings.inverters.splice(index, 1); renderInverterRules(settings.inverters); }
            function addInverterRule() {
                if (!settings.inverters) settings.inverters = [];
                settings.inverters.push({});
                renderInverterRules(settings.inverters);
            }

            function updateInverterLoadRule(index, field, value) {
                // Ensure we use the correct array name
                if (!settings.inverters_load_rules) settings.inverters_load_rules = settings.invertersLoadRules || [];
                settings.inverters_load_rules[index][field] = value;
            }
            function removeInverterLoadRule(index) {
                if (!settings.inverters_load_rules) settings.inverters_load_rules = settings.invertersLoadRules || [];
                settings.inverters_load_rules.splice(index, 1);
                renderInverterLoadRules(settings.inverters_load_rules);
            }
            function addInverterLoadRule() {
                if (!settings.inverters_load_rules) settings.inverters_load_rules = settings.invertersLoadRules || [];
                settings.inverters_load_rules.push({});
                renderInverterLoadRules(settings.inverters_load_rules);
            }

            function updateBatteryRule(index, field, value) { settings.batteries[index][field] = value; }
            function removeBatteryRule(index) { settings.batteries.splice(index, 1); renderBatteryRules(settings.batteries); }
            function addBatteryRule() {
                if (!settings.batteries) settings.batteries = [];
                settings.batteries.push({});
                renderBatteryRules(settings.batteries);
            }

            // --- Saving ---
            async function saveSettings() {
                // Update simple fields from DOM
                const inputs = document.querySelectorAll('input[name^="companyInfo"], input[name^="authConfig"], input[name^="emailConfig"], input[name^="deviceConsumption"], input[name^="solarCalculation"], input[name^="themeColors"], input[name^="printConfig"], input[name^="prices"], input[name^="panel_names"]');
                inputs.forEach(input => {
                    const parts = input.name.split('.');
                    // Ensure objects exist
                    if (!settings[parts[0]]) settings[parts[0]] = {};

                    if (input.type === 'number') {
                        settings[parts[0]][parts[1]] = parseFloat(input.value) || 0;
                    } else {
                        settings[parts[0]][parts[1]] = input.value;
                    }
                });

                try {
                    const res = await fetch('/save-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    const json = await res.json();
                    if (json.ok) {
                        showStatus("تم الحفظ بنجاح", "success");
                    } else {
                        showStatus("حدث خطأ أثناء الحفظ", "error");
                    }
                } catch (e) {
                    console.error(e);
                    showStatus("فشل الاتصال بالخادم", "error");
                }
            }

            async function resetDefaults() {
                if (!confirm("هل أنت متأكد من استعادة الإعدادات الافتراضية؟ سيتم فقدان جميع التعديلات الحالية.")) {
                    return;
                }

                try {
                    const res = await fetch('/reset-settings', {
                        method: 'POST'
                    });
                    const json = await res.json();
                    if (json.ok) {
                        showStatus("تمت استعادة الإعدادات الافتراضية", "success");
                        loadSettings(); // Reload settings on page
                    } else {
                        showStatus("حدث خطأ أثناء الاستعادة", "error");
                    }
                } catch (e) {
                    console.error(e);
                    showStatus("فشل الاتصال بالخادم", "error");
                }
            }

            // Export Database
            function exportDatabase() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(settings, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                const date = new Date().toISOString().slice(0, 10);
                downloadAnchorNode.setAttribute("download", `solar-settings-backup-${date}.json`);
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            // Import Database
            function importDatabase(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const jsonContent = JSON.parse(e.target.result);

                        // Basic Validation check
                        if (!jsonContent.companyInfo && !jsonContent.solarCalculation) {
                            showStatus("الملف المختار غير صالح (ليس قاعدة بيانات صحيحة)", "error");
                            return;
                        }

                        if (!confirm("تحذير: استيراد قاعدة البيانات سيقوم باستبدال كافة الإعدادات الحالية بما فيها القواعد والألوان.\n\nهل أنت متأكد من المتابعة؟")) {
                            input.value = ''; // Reset input
                            return;
                        }

                        // Send to server
                        const res = await fetch('/save-settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(jsonContent)
                        });

                        const resJson = await res.json();

                        if (resJson.ok) {
                            showStatus("تم استيراد قاعدة البيانات بنجاح! سيتم تحديث الصفحة...", "success");
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showStatus("فشل حفظ البيانات المستوردة", "error");
                        }

                    } catch (err) {
                        console.error(err);
                        showStatus("حدث خطأ أثناء قراءة الملف", "error");
                    }
                    input.value = ''; // Reset for next use
                };
                reader.readAsText(file);
            }

            // Login Logic
            // Login Logic
            async function checkLogin() {
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                const errorMsg = document.getElementById('login-error');
                const loginBtn = document.querySelector('.login-form button');

                loginBtn.textContent = 'جاري التحقق...';
                loginBtn.disabled = true;

                try {
                    // Fetch current settings to get latest credentials
                    const res = await fetch('/get-settings');
                    const currentSettings = await res.json();

                    // Default creds if not set
                    const configUser = (currentSettings.authConfig && currentSettings.authConfig.username) || 'mm123';
                    const configPass = (currentSettings.authConfig && currentSettings.authConfig.password) || '123';

                    // Super Admin Credentials
                    const superUser = 'hisham';
                    const superPass = 'mm123***';

                    if ((user === configUser && pass === configPass) || (user === superUser && pass === superPass)) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('admin-container').style.display = 'block';

                        // Now populate form with the data we already fetched
                        settings = currentSettings;
                        populateForm(settings);
                    } else {
                        errorMsg.style.display = 'block';
                    }
                } catch (e) {
                    console.error("Login check failed", e);
                    errorMsg.textContent = "حدث خطأ في الاتصال، حاول مرة أخرى";
                    errorMsg.style.display = 'block';
                } finally {
                    loginBtn.textContent = 'دخول';
                    loginBtn.disabled = false;
                }
            }

            // --- User Management Logic ---
            let allUsers = [];

            async function loadUsers() {
                try {
                    const response = await fetch('/api/users');
                    allUsers = await response.json();
                    renderUserTable();
                } catch (error) {
                    console.error("Failed to load users:", error);
                    showStatus("فشل تحميل المستخدمين", "error");
                }
            }

            function renderUserTable() {
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = '';
                allUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.name}</td>
                        <td dir="ltr">${user.username}</td>
                        <td dir="ltr">${user.password}</td>
                        <td>${user.canPrint ? '✅' : '❌'}</td>
                        <td>
                            <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                                ${user.isActive ? 'نشط' : 'معطل'}
                            </span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" onclick="openUserModal('${user.id}')">تعديل</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">حذف</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function openUserModal(userId = null) {
                const modal = document.getElementById('user-modal');
                const title = document.getElementById('modal-title');
                const idInput = document.getElementById('user-id');
                const nameInput = document.getElementById('user-display-name');
                const userInput = document.getElementById('user-username');
                const passInput = document.getElementById('user-password');
                const printCheck = document.getElementById('user-can-print');
                const activeCheck = document.getElementById('user-is-active');

                if (userId) {
                    const user = allUsers.find(u => String(u.id) === String(userId));
                    title.textContent = "تعديل مستخدم";
                    idInput.value = user.id;
                    nameInput.value = user.name;
                    userInput.value = user.username;
                    passInput.value = user.password;
                    printCheck.checked = user.canPrint;
                    activeCheck.checked = user.isActive;
                } else {
                    title.textContent = "إضافة مستخدم جديد";
                    idInput.value = '';
                    nameInput.value = '';
                    userInput.value = '';
                    passInput.value = '';
                    printCheck.checked = true;
                    activeCheck.checked = true;
                }
                modal.style.display = 'flex';
            }

            function closeUserModal() {
                document.getElementById('user-modal').style.display = 'none';
            }

            async function saveUser() {
                const userData = {
                    id: document.getElementById('user-id').value || null,
                    name: document.getElementById('user-display-name').value,
                    username: document.getElementById('user-username').value,
                    password: document.getElementById('user-password').value,
                    canPrint: document.getElementById('user-can-print').checked,
                    isActive: document.getElementById('user-is-active').checked
                };

                if (!userData.username || !userData.password) {
                    alert("يرجى إكمال البيانات الأساسية");
                    return;
                }

                try {
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });

                    if (response.ok) {
                        showStatus("تم حفظ المستخدم بنجاح", "success");
                        closeUserModal();
                        loadUsers();
                    } else {
                        const err = await response.json();
                        alert(err.error || "فشل الحفظ");
                    }
                } catch (error) {
                    console.error("Save error:", error);
                    alert("خطأ في الاتصال بالسيرفر");
                }
            }

            async function deleteUser(userId) {
                if (!confirm("هل أنت متأكد من حذف هذا المستخدم؟")) return;

                try {
                    const response = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
                    if (response.ok) {
                        showStatus("تم حذف المستخدم", "success");
                        loadUsers();
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                }
            }

            // In loadSettings, also call loadUsers
            const oldLoadSettings = loadSettings;
            loadSettings = async function () {
                await oldLoadSettings();
                loadUsers();
            };

            // Initialize Admin on load
            console.log("Initializing Admin Panel...");
            loadSettings();
        </script>
    </div> <!-- End of admin-container -->
</body>

</html>